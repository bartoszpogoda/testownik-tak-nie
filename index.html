<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="libs/css/bootstrap.min.css">

  <script src="libs/js/jquery-3.2.1.min.js"></script>
  <script src="libs/js/bootstrap.min.js"></script>
  <script src="libs/js/bootstrap-notify.js"></script>

  <title>SO- Nauka</title>
  <style>
    .buttonsTd {
      width: 150px;
    }

    .btn-yes.answered {
      background-color: #a1e1a1;
    }

    .btn-no.answered {
      background-color: #f4abab;
    }

    .blink {
      background-color: #f3c2c2 !important;
    }

    .blink-not-answered {
      background-color: #fed7b7 !important;
    }

    img {
      width: 100%;
    }
  </style>
</head>

<body>
<div class="container">
  <div class="row" style="margin-top:15px;">
    <div class="col-md-8 col-md-offset-1">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Pytanie nr. <span id="currentId"></span> (<span id="arrayId"></span>/<span id="maxId"></span>)</h3>
        </div>
        <div class="panel-body">
          <h4 id="description">Description here...</h4>
          <table class="table table-striped">
            <tbody id="questionsTable">
              <tr>
                <td>
                  Question 1.
                </td>
                <td class="buttonsTd">
                  <div class="btn-group" role="group">
                    <button type="button" class="btn btn-default btn-yes">TAK</button>
                    <button type="button" class="btn btn-default btn-no">NIE</button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="btn-group pull-right" role="group">
            <button id="btn-next" type="button" class="btn btn-default">Następne</button>
          </div>

        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Dobra passa</h3>
        </div>
        <div class="panel-body" style="text-align:center;">
          <h2 id="correctInARow">
            0
          </h2>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Nauczone</h3>
        </div>
        <div class="panel-body" style="text-align:center;">
          <h2 id="learnedTotal">
            0
          </h2>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Do nauczenia</h3>
        </div>
        <div class="panel-body" style="text-align:center;">
          <h2 id="toLearnTotal">
            0
          </h2>
        </div>
      </div>
    </div>
  </div>


</div>

</body>
<script>

  var questionsData = [];  // question Pool
  var currentQuestionWasAnsweredBad = false;
  var currentQuestionsAnswered = 0;

  var currentId = 0;
  var maxId = 0;

  init();

  function init() {

      $.getJSON("data.json", function(json) {
        questionsData = json.data;
        maxId = questionsData.length - 1;
        $('#maxId').text(maxId + 1);

        questionsData = shuffle(questionsData);

        questionsData.forEach(function(question) {
          question.counter = 1;
        })


        $('#toLearnTotal').text(maxId + 1);

        showQuestion(currentId);
      });

      $('#btn-next').click(function() {

        if(currentQuestionsAnswered < questionsData[currentId].questions.length) {

          var toBlink = $('tr').not('.already-answered'); // Save reference for better performance
          toBlink.addClass("blink-not-answered");
          var backgroundInterval = setTimeout(function() {
            toBlink.removeClass("blink-not-answered");
          }, 200)

          $.notify({
          // options
          message: 'Nie odpowiedziałeś na wszystkie pytania!'
          },{
          // settings
          type: 'danger',
          placement : {
            from: 'bottom',
            align: 'center'
          },
          delay: 1000
          });

        } else {

          if(currentQuestionWasAnsweredBad) {
            // there was bad answer within current questions
            if(questionsData[currentId].counter < 2) {
              questionsData[currentId].counter++;
            }

            currentId++;

          } else {
            // each of theq uestions was answered correctly

            questionsData[currentId].counter--;

            if(questionsData[currentId].counter <= 0 ) {
              questionsData.splice(currentId, 1);

              $.notify({
            	// options
            	message: 'Opanowałeś zagadnienie!'
            },{
            	// settings
            	type: 'success',
              placement : {
                from: 'bottom',
                align: 'center'
              },
              delay: 1000
            });

              $('#learnedTotal').text(parseInt($('#learnedTotal').text()) + 1);
              $('#toLearnTotal').text(maxId + 1 - parseInt($('#learnedTotal').text()));

            } else {
              currentId++;
            }

          }

          if (currentId < questionsData.length) {
            showQuestion(currentId);
          } else if(questionsData.length > 0){

            $.notify({
            // options
            message: 'Rozpoczynasz kolejną serię'
          },{
            // settings
            type: 'info',
            placement : {
              from: 'bottom',
              align: 'center'
            },
            delay: 1000
          });

            questionsData = shuffle(questionsData);

            currentId = 0;
            showQuestion(currentId);
          } else {
            showSuccessScreen();
          }
        }


      })

  }

  function showQuestion(arrayId) {
    var question = questionsData[arrayId];
    currentQuestionWasAnsweredBad = false;
    currentQuestionsAnswered = 0;

    $('#description').text(question.description);

    var questionsTable = $('#questionsTable');
    questionsTable.empty();

    question.questions = shuffle(question.questions);

    question.questions.forEach(function(q) {

      if (q.answer) {
        var btnYes = '<button type="button" class="btn btn-default btn-yes good-answer">TAK</button>';
        var btnNo = '<button type="button" class="btn btn-default btn-no">NIE</button>';
      } else {
        var btnYes = '<button type="button" class="btn btn-default btn-yes">TAK</button>';
        var btnNo = '<button type="button" class="btn btn-default btn-no good-answer">NIE</button>';
      }

      var buttonsTd = '<td class="buttonsTd"><div class="btn-group pull-right" role="group">' + btnYes + btnNo + '</div></td>';
      var element = "<tr><td>" + q.question + "</td>" + buttonsTd + "</tr>";

      questionsTable.append(element);
    })

    questionsTable.find('button').click(onAnswer);
    $('#arrayId').text(currentId + 1);
    $('#maxId').text(questionsData.length);
    $('#currentId').text(question.id );
    document.body.scrollTop = document.documentElement.scrollTop = 0;
  }

  function onAnswer() {
    if ($(this).hasClass('good-answer')) {
        if($(this).hasClass("answered")) {
          // already answered
          return;
        }

        if(!$(this).parents('tr').hasClass('already-answered')) {
          $('#correctInARow').text(parseInt($('#correctInARow').text()) + 1);
          currentQuestionsAnswered++;
        }
        onCorrectAnswer($(this));

    } else {

      if(!$(this).parents('tr').hasClass('already-answered')) {
        currentQuestionsAnswered++;
      }
      onBadAnswer($(this));
    }

    $(this).parents('tr').addClass('already-answered');
  }

  function onCorrectAnswer(element) {
    element.addClass("answered");
  }

  function onBadAnswer(element) {
    currentQuestionWasAnsweredBad = true;

    $('#correctInARow').text(0);
    // blink on bad answered
    var toBlink = element.parents('tr'); // Save reference for better performance
    toBlink.addClass("blink");
    var backgroundInterval = setTimeout(function() {
      toBlink.removeClass("blink");
    }, 100)
  }

  function shuffle(array) {
    var currentIndex = array.length,
      temporaryValue, randomIndex;

    // While there remain elements to shuffle...
    while (0 !== currentIndex) {

      // Pick a remaining element...
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex -= 1;

      // And swap it with the current element.
      temporaryValue = array[currentIndex];
      array[currentIndex] = array[randomIndex];
      array[randomIndex] = temporaryValue;
    }

    return array;
  }

  function showSuccessScreen() {
    $('body').empty();

    var imgElem = '<img src="https://media1.giphy.com/media/3oEjI5VtIhHvK37WYo/giphy.gif" /><img src="https://media.giphy.com/media/9uoYC7cjcU6w8/giphy.gif" /><img src="https://media2.giphy.com/media/E6LPrrzKOJwhG/giphy.gif" />';

    $('body').append(imgElem);
  }

</script>

</html>
